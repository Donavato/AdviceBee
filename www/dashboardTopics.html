<!--
All of the user's followed topics are displayed and they can sort the posts they see by clicking on a topic.
-->
<head>
    <link rel="stylesheet" href="style.css">
    <!--dashboardTopics stylesheet-->
    <link rel="stylesheet" type="text/css" href="css/dashboardTopics.css" />
</head>
<div id="topicsButtons">

</div>

<script type="text/javascript">
    //call ajax
    var ajax = new XMLHttpRequest();
    var method = "GET";
    var url = "http://13.59.122.228/api/Profile/dashboardTopics.php";
    var asynchronous = true;

    ajax.open(method, url, asynchronous);

    //sending ajax
    ajax.send();

    //recieve response
    ajax.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
            //converting JSON to array
            var data = JSON.parse(this.responseText);

            //append to html
            var html = "";

            for (var a = 0; a < data.length; a++) {
                //set array information for current topic in variables
                var id = data[a].Topic_ID;
                var name = data[a].Topic_name;
                var imageURL = data[a].topicImage;

                //create button for each topic to display questions
                html += "<li><button class='makeCircleButton' id=" + id + " value=" + name + " onclick='displayQuestions(this.value, this.id)'><img src='" + imageURL + "' class='makeCircle'></button>";
                html += "<p class='textsize'>" + name + "</p></li>";

                //replace in html
                document.getElementById("topicsButtons").innerHTML = html;
            }
        }
    }
</script>

<script type="text/javascript">

    function displayQuestions(obj, tID) {
        var topic_name = obj;
        sessionStorage.setItem('topic_obj', obj);
        var topic_ID = tID;

        //call ajax
        $(document).ready(function () {
            sessionStorage.removeItem('topic_id');
            sessionStorage.setItem('topic_id', topic_ID);
            $.ajax({
                method: "POST",
                url: "http://13.59.122.228/api/Profile/displaytopicquestions.php",
                data: { Topic_Name: topic_name },
                //on success it will call this function
                success: function (data) {
                    var topicsButtons = $('#DOM');
                    var arrayQuestions = data;

                    //empty the current div from questions to post the new questions from the topic selected
                    topicsButtons.empty();
                    //GET DATA AND PARSE IT
                    $.each(arrayQuestions, function (key, value) {

                        //APPEND DATA AND DISPLAY IT

                        value.dImage = (value.dImage === "<img src = >") ? '' : value.dImage;
                        topicsButtons.append(`
                            <div class="post">
                                ${value.pImage}
                                <div class="main-body">
                                    <div class="post-header">
                                        <span>${value.name}</span>
                                        <div class="subject">${value.Subject}</div>
                                    </div>
                                    <div class="post-body">
                                            ${value.dImage}
                                            <div class="description">${value.Description}</div>
                                    </div>
                                    <div class="post-footer" style="font-size: 1.3rem;"> 
                                        <div>
                                            <i class="far fa-comment" onclick="sendButton(${value.Question_ID})"></i>
                                            ${value.c_count}
                                        </div>
                                        <i class="fas fa-exclamation" onclick="reportButton(${value.Question_ID})"></i>
                                        <i class="far fa-user" id="follow(${value.Question_ID})" onclick="followButtonTopics(${value.Question_ID} , ${value.user_ID2})"></i>
                                        
                                        <div id="u_Heart">
                                        <i class="far fa-heart" id="heart(${value.Question_ID})" onclick="likeButtonTopics(${value.Question_ID})"></i>${value.likes}<!-- unfilled -->
                                        </div>

                                        <!--<i class="far fa-heart" onclick="reportButton(${value.Question_ID})"></i> filled -->
                                        <!-- <i class="far fa-share-square" onclick="sendButton(${value.Question_ID})"></i> -->
                                        <a class="twitter-share-button"
                                        href="https://twitter.com/intent/tweet?text=${value.Description}"><i class="fab fa-twitter" style="color:black" ></i></a>

                                    </div>
                                </div>
                            </div>
                            `)
                        var Question_ID = value.Question_ID;

                        $.ajax({
                            url: "http://13.59.122.228/api/Question/checkquestion.php",
                            type: "POST",
                            data: { Question_ID, Question_ID },
                            //on success it will call this function
                            success: function (data) {
                                //change button color
                                var heart = document.getElementById("heart(" + value.Question_ID + ")");
                                if (data == 1) {
                                    heart.style.color = "red";
                                }
                                else {
                                    heart.style.color = "black";
                                }
                            }
                        });

                        var User_ID = value.user_ID2;
                        $.ajax({
                            url: "http://13.59.122.228/api/Question/checkfollow.php",
                            type: "POST",
                            data: { uID2: User_ID, qID: Question_ID },
                            //on success it will call this function
                            success: function (data) {
                                //change button color
                                var follow = document.getElementById("follow(" + value.Question_ID + ")");
                                if (data == 1) {
                                    follow.style.color = "green";
                                }
                                else {
                                    follow.style.color = "black";
                                }
                            }
                        });

                    });
                    //if fail it will give this error
                }, error: function (e) {
                    popup("failed to work");
                }

            });

        });
    }


    function likeButtonTopics(questionID) {

        var Question_ID = questionID;
        var dataString = "Question_ID=" + Question_ID;

        $.ajax({
            url: "http://13.59.122.228/api/Question/likequestion.php",
            type: "POST",
            dataType: "json",
            data: dataString,
            //on success it will call this function
            success: function (data) {
                var topic_obj = sessionStorage.getItem("topic_obj");
                var tID = sessionStorage.getItem("topic_id");
                displayQuestions(topic_obj, tID);

            }

        });
    }

    function followButtonTopics(qID, user_ID2) {
    var qID = qID;
    var uID2 = user_ID2;
    var dataString = "qID=" + qID + "&uID2=" + uID2;

    $.ajax({
        url: "http://13.59.122.228/api/Question/followuser.php",
        type: "POST",
        dataType: "json",
        data: dataString,
        //on success it will call this function
        success: function (data) {
            var topic_obj = sessionStorage.getItem("topic_obj");
            var tID = sessionStorage.getItem("topic_id");
            
            if (data == "Cannot follow user!") {
                popup(data);
            } else {
                displayQuestions(topic_obj, tID);
            }
            
        }

    });

}


</script>